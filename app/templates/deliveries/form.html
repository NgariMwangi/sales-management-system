{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}
{% block content %}
<h2 class="mb-4">{{ title }}</h2>
<form method="post" id="deliveryForm">
    {{ form.hidden_tag() }}
    <div class="mb-3">
        {{ form.delivery_type.label(class="form-label") }}
        {{ form.delivery_type(class="form-select") }}
    </div>
    <div class="mb-3" id="orderSelectWrap">
        {{ form.order_id.label(class="form-label") }}
        <select name="order_id" class="form-select" id="orderSelect">
            <option value="">-- Select order --</option>
            {% for o in orders %}
            <option value="{{ o.id }}">{{ o.order_number }} - {{ o.customer_name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="row mb-3">
        <div class="col-md-4">{{ form.customer_name.label(class="form-label") }}{{ form.customer_name(class="form-control") }}</div>
        <div class="col-md-4">{{ form.phone.label(class="form-label") }}{{ form.phone(class="form-control") }}</div>
    </div>
    <div class="mb-3">
        {{ form.delivery_address.label(class="form-label") }}
        {{ form.delivery_address(class="form-control", rows=2) }}
    </div>
    <div class="row mb-3">
        <div class="col-md-4">{{ form.scheduled_date.label(class="form-label") }}{{ form.scheduled_date(class="form-control") }}</div>
        <div class="col-md-4">{{ form.assigned_to_id.label(class="form-label") }}{{ form.assigned_to_id(class="form-select") }}</div>
        <div class="col-md-4">{{ form.status.label(class="form-label") }}{{ form.status(class="form-select") }}</div>
    </div>
    <div class="mb-3" id="standaloneItems" style="display:none">
        <label class="form-label">Items</label>
        <table class="table table-sm" id="itemsTable">
            <thead><tr><th>Product</th><th>Qty</th><th>Price</th><th></th></tr></thead>
            <tbody id="itemsBody"></tbody>
        </table>
        <button type="button" class="btn btn-sm btn-outline-primary" id="addItem">Add item</button>
        <input type="hidden" name="items_json" id="itemsJson" value="[]">
    </div>
    <div class="mb-3">
        {{ form.delivery_notes.label(class="form-label") }}
        {{ form.delivery_notes(class="form-control", rows=2) }}
    </div>
    <input type="hidden" name="item_quantities_json" id="itemQuantitiesJson" value="{}">
    <button type="submit" class="btn btn-primary">Save</button>
    <a href="{{ url_for('deliveries.list') }}" class="btn btn-secondary">Cancel</a>
</form>
{% endblock %}
{% block extra_js %}
<script>
(function(){
    const typeSelect = document.querySelector('select[name="delivery_type"]');
    const orderWrap = document.getElementById('orderSelectWrap');
    const standaloneWrap = document.getElementById('standaloneItems');
    const itemsJson = document.getElementById('itemsJson');
    let standaloneItems = [];
    function toggle(){
        const isOrder = typeSelect.value === 'order';
        orderWrap.style.display = isOrder ? 'block' : 'none';
        standaloneWrap.style.display = isOrder ? 'none' : 'block';
    }
    typeSelect.onchange = toggle;
    toggle();
    document.getElementById('addItem').onclick = () => {
        const name = prompt('Product name');
        if (!name) return;
        const qty = parseInt(prompt('Quantity', '1')) || 1;
        const price = parseFloat(prompt('Unit price', '0')) || 0;
        standaloneItems.push({ product_name: name, quantity: qty, unit_price: price });
        renderStandalone();
    };
    function renderStandalone(){
        const tbody = document.getElementById('itemsBody');
        tbody.innerHTML = standaloneItems.map((it, idx) =>
            '<tr><td>'+ it.product_name +'</td><td>'+ it.quantity +'</td><td>'+ it.unit_price +'</td><td><button type="button" class="btn btn-sm btn-danger" data-idx="'+ idx +'">Remove</button></td></tr>'
        ).join('');
        tbody.querySelectorAll('button').forEach(btn => {
            btn.onclick = () => { standaloneItems.splice(parseInt(btn.dataset.idx),1); renderStandalone(); };
        });
        itemsJson.value = JSON.stringify(standaloneItems);
    }
    document.getElementById('deliveryForm').onsubmit = () => {
        if (typeSelect.value === 'standalone' && standaloneItems.length === 0) {
            alert('Add at least one item.'); return false;
        }
        if (typeSelect.value === 'order' && !document.getElementById('orderSelect').value) {
            alert('Select an order.'); return false;
        }
        itemsJson.value = JSON.stringify(standaloneItems);
        return true;
    };
})();
</script>
{% endblock %}
